{% extends "partials/base.html" %}
{% load static %}
{% block content %}
        <main class="main">
            <nav class="breadcrumb-nav">
                <div class="container">
                    <ul class="breadcrumb">
                        <li><a href="/"><i class="d-icon-home"></i> Home</a></li>
                        <li>Wishlist</li>
                    </ul>
                </div>
            </nav>
            <div class="page-content pt-10 pb-10 mb-2">
                <div class="container">
                    <table class="shop-table wishlist-table mt-2 mb-4">
                        {% if wishlist_items  %}
                        <thead>
                            <tr>
                                <th class="product-name"><span>Product</span></th>
                                <th></th>
                                <th class="product-price"><span>Price</span></th>
                                <th class="product-stock-status"><span>Stock status</span></th>
                                <th class="product-add-to-cart"></th>
                                <th class="product-remove"></th>
                            </tr>
                        </thead>
                        {% endif %}
                        <tbody class="wishlist-items-wrapper">
                            
                            {% if wishlist_items %}
                                {% for item in wishlist_items %}
                                <tr  id="wishlist-item-{{ item.id }}">
                                    <td class="product-thumbnail">
                                        <a href="{% url "core:product-detail" item.product.slug %}">
                                            <figure>
                                                <img src="{{item.product.image.url}}" width="100" height="100" style="border-radius: 1.25rem;"
                                                    alt="product">
                                            </figure>
                                        </a>
                                    </td>
                                    <td class="product-name">
                                        <a href="{% url "core:product-detail" item.product.slug %}">{{item.product.name|capfirst}}</a>
                                    </td>
                                    <td class="product-price">
                                        <span class="amount">â‚¦{{item.product.price}}</span>
                                    </td>
                                    <td class="product-stock-status">
                                        <span class="wishlist-in-stock">{% if p.finished %}Out Of Stock {% else %}<span >In Stock</span>{% endif %} </span>
                                    </td>
                                    <td class="product-add-to-cart">
                                        <a href="#" style="border-radius: 3.75rem;"   class="btn-product btn-primary"><span>Add to cart</span></a>
                                    </td>
                                    <td class="product-remove">
                                        <div>
                                            <a href="#" class="remove" data-product-item="{{ item.product.id }}" data-url="{% url 'core:remove_from_wishlist' item.product.id %}" title="Remove this product">
                                                <i class="fas fa-times"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                            <h2 class="title title-center mb-5">No items in wishlist</h2>
                            {% endif %}
                        </tbody>
                    </table>
               <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        $('.btn-delete-wishlist').click(function() {
                            let productId = $(this).attr('data-product-item');
                            let this_val = $(this);
                    
                            $.ajax({
                                url: $(this).attr('data-url'),
                                type: 'POST',
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token }}',  // Ensure you include the CSRF token
                                    'Content-Type': 'application/json',
                                },
                                data: JSON.stringify({ id: productId }),
                                dataType: 'json',
                                beforeSend: function() {
                                    // Show a spinner while processing the request
                                    this_val.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');
                                },
                                success: function(data) {
                                    if (data.success) {
                                        // Remove the item row from the DOM
                                        $(`#wishlist-item-${productId}`).remove();
                                    } else {
                                        // Handle failure
                                        this_val.html('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 8L12 12M12 12L8 16M12 12L8 8M12 12L16 16" stroke="rgba(0,0,0,0.95)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="10" stroke="rgba(0,0,0,0.95)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></circle></svg>');
                                    }
                                },
                                error: function(xhr, textStatus, errorThrown) {
                                    console.error('Error:', errorThrown);
                                    // Handle the error gracefully by restoring the button
                                    this_val.html('<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16 8L12 12M12 12L8 16M12 12L8 8M12 12L16 16" stroke="rgba(0,0,0,0.95)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><circle cx="12" cy="12" r="10" stroke="rgba(0,0,0,0.95)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></circle></svg>');
                                }
                            });
                        });
                    });
                    
                </script>
                </div>
            </div>
        </main>
{% endblock content %}